<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script>
    $(function () {

        // داده‌ها از مدل Razor
        var sellers = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.GetSeller));
        var ProductPrice = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.GetProductPrice));

        // وقتی رنگ انتخاب می‌شود
        $('.color-id').click(function () {
            var colorId = $(this).data("id");
            var productsByColor = GetProductByColorId(colorId);

            // مرتب‌سازی بر اساس FinalPrice و سپس کمترین SubmitDate
            productsByColor.sort((a, b) => {
                if(a.FinalPrice === b.FinalPrice){
                    return (a.SubmitDate ?? 0) - (b.SubmitDate ?? 0);
                }
                return a.FinalPrice - b.FinalPrice;
            });

            var mainProduct = productsByColor[0];
            var mainSeller = sellers.find(x => x.SellerId == mainProduct.SellerId);

            UpdateProduct(mainProduct, mainSeller, productsByColor.length);
            printSeller(productsByColor);
        });

        // گرفتن محصولات بر اساس رنگ
        function GetProductByColorId(ColorId) {
            return ProductPrice.filter(x => x.ColorId == ColorId);
        }

        // آپدیت بخش بالای محصول
            function UpdateProduct(product, seller, sellerCount) {
        $(".guarantee-name").text(product.GuaranteeName);

        const relatedProducts = GetProductByColorId(product.ColorId);

        // انتخاب محصولی که همون productId هست (تا تخفیفش مشخص باشه)
        const currentProduct = relatedProducts.find(p => p.ProductPriceId === product.ProductPriceId);

        // قیمت نهایی (اگر FinalPrice داشت می‌گیریم، در غیر این صورت MainPrice)
        var finalPrice = currentProduct.FinalPrice && currentProduct.FinalPrice > 0
            ? currentProduct.FinalPrice
            : currentProduct.MainPrice;

        var priceHtml = currentProduct.HasDiscount
            ? `<span style="text-decoration:line-through;color:gray">${Number(currentProduct.MainPrice).toLocaleString('fa-IR')}</span>
               <span style="color:red;font-weight:bold">${Number(finalPrice).toLocaleString('fa-IR')}</span>`
            : `<span style="font-weight:bold">${Number(finalPrice).toLocaleString('fa-IR')}</span>`;

        $(".js-price").html(priceHtml); // 👈 به جای text از html استفاده می‌کنیم

        $(".length-seller").text(sellerCount);

        // به‌روز کردن دکمه افزودن به سبد
        $(".add-product-price-a")
            .attr('data-product-id', product.ProductPriceId)
            .attr('href', 'javascript:void(0);');

        $(".js-inventory").text(
            product.SubmitDate == null
                ? "موجود در انبار"
                : "ارسال از " + product.SubmitDate + " روز کاری"
        );
    }

        // چاپ لیست فروشنده‌ها
        function printSeller(products) {
            $(".sellers").html("");
            $(".show-less").hide();
            $(".show-more").show();
            var inventoryText = "در انبار موجود است";

            // مرتب‌سازی محصولات بر اساس FinalPrice و SubmitDate
            products.sort((a, b) => {
                if(a.FinalPrice === b.FinalPrice){
                    return (a.SubmitDate ?? 0) - (b.SubmitDate ?? 0);
                }
                return a.FinalPrice - b.FinalPrice;
            });

            products.forEach((product, index) => {
                var seller = sellers.find(x => x.SellerId == product.SellerId);

                var rowClass = index == 0 ? "table-suppliers-row-active" : index >= 2 ? "in-filter in-list" : '';
                var submitText = product.SubmitDate == null ? inventoryText : "ارسال از " + product.SubmitDate + " روز کاری دیگر";

                // مطمئن شدن از FinalPrice معتبر
                var finalPrice = product.FinalPrice && product.FinalPrice > 0 ? product.FinalPrice : product.MainPrice;

                var priceHtml = product.HasDiscount
                    ? `<span style="text-decoration:line-through;color:gray">${Number(product.MainPrice).toLocaleString('fa-IR')}</span>
                       <span style="color:red;font-weight:bold">${Number(finalPrice).toLocaleString('fa-IR')}</span> تومان`
                    : `<span style="font-weight:bold">${Number(finalPrice).toLocaleString('fa-IR')} تومان</span>`;

                var html = `
                <div class="table-suppliers-row ${rowClass}">
                    <div class="table-suppliers-cell table-suppliers-cell-title">
                        <div class="seller-wrapper">
                            <p class="table-suppliers-seller-name">
                                <span><a href="#">${seller.SellerName}</a></span>
                            </p>
                        </div>
                    </div>
                    <div class="table-suppliers-cell table-suppliers-cell-no-lead-time">
                        <div class="seller-wrapper">
                            <p>${submitText}</p>
                        </div>
                    </div>
                    <div class="table-suppliers-cell table-suppliers-cell-guarantee">
                        <div class="seller-wrapper">
                            <span>${product.GuaranteeName}</span>
                        </div>
                    </div>
                    <div class="table-suppliers-cell table-suppliers-cell-price">
                        <div class="seller-wrapper">
                            <div class="price-value">
                                ${priceHtml}
                            </div>
                        </div>
                    </div>
                    <div class="table-suppliers-cell table-suppliers-cell-action">
                        <div class="seller-wrapper">
                            <a href="javascript:void(0);" class="js-btn-add-to-cart" data-product-id="${product.ProductPriceId}">افزودن به سبد</a>
                        </div>
                    </div>
                </div>
                `;

                $(".sellers").append(html);
            });
        }

        // مدیریت دکمه "مشاهده بیشتر"
        $(document).on("click", ".show-more", function(e){
            e.preventDefault();
            $(".sellers .in-filter").removeClass("in-filter");
            $(".show-more").hide();
            $(".show-less").show();
        });

        // مدیریت دکمه "کمتر"
        $(document).on("click", ".show-less", function(e){
            e.preventDefault();
            $(".sellers .table-suppliers-row").each(function(index){
                if(index >= 2){
                    $(this).addClass("in-filter");
                }
            });
            $(".show-less").hide();
            $(".show-more").show();
        });

        // افزودن محصول به سبد
        $(document).on("click", ".btn-add-to-cart, .add-product-price-a, .js-btn-add-to-cart", function(e){
            e.preventDefault();
            var productId = $(this).data("product-id");
            if(!productId) return;

            $.ajax({
                url: "/AddCart/" + productId,
                type: "GET",
                success: function(res){
                    console.log("محصول اضافه شد", res);
                    location.reload();
                },
                error: function(){
                    alert("خطا در افزودن به سبد خرید");
                }
            });
        });

        // اجرای اولین رنگ پیش‌فرض
        $('.color-id').first().click();
    });
</script>
